{% extends "index.html" %}

{% block content %}

  <nav class="navbar navbar-expand-lg bg-body-tertiary" style="height: 5% !important; padding-top: 1%; padding-bottom: 1.5%;">
    <div class="container-fluid">
      <form action="/show_timetable" method="POST">
        <div class="form-group d-flex align-items-center form-group-1">
          <label>Select Class:</label>
          <select name="sel_class" class="form-select" aria-label="Default select example" style="width: 205px !important;">
              <option selected disabled>Class</option>
              {% for class in class_res %}
                  <option value="{{ class[0]+' '+class[1] }}">{{ class[0]+' '+class[1] }}</option>
              {% endfor %}
          </select>
          <button type="submit" name="button_submit" value="view" style="margin-top: 30px;">View</button>
          <button type="submit" name="button_submit" value="edit" style="margin-left: 5px;margin-top: 30px;">Edit </button>
          <button type="submit" name="button_submit" value="swap" style="margin-left: 5px;margin-top: 30px;width: 125px;">Swap Slots</button>
        </div>
      </form>
      <form action="/show_timetable" method="POST">
        <div class="form-group d-flex align-items-center form-group-1">
          <label>Select Room:</label>
          <select name="sel_room" class="form-select" aria-label="Default select example" onchange="showColor(this)">
              <option selected disabled>Room</option>
              {% for room in room_res %}
                  <option value="{{ room[0] }}">{{ room[0] }}</option>
              {% endfor %}
          </select>
          <button type="submit">Submit</button>
        </div>
      </form>
      <form action="/show_timetable" method="POST">
        <div class="form-group d-flex align-items-center form-group-1">
          <label>Select Faculty:</label>
          <select name="sel_fac" class="form-select" aria-label="Default select example" onchange="showColor(this)">
              <option selected disabled>Faculty</option>
              {% for faculty in fac_res %}
                  <option value="{{ faculty[0] }}">{{ faculty[0] }}</option>
              {% endfor %}
          </select>
          <button type="submit">Submit</button>
        </div>
      </form>
    </div>
  </nav>
  {% block timeshow %}
  {% endblock timeshow %}


<script>
  
function showColor(element) {
    const currTimeTable = document.getElementById("time-table-shown");
    const getTableOf = element.name;
    const getTableValue = element.value;

    const sendInfo = {
        "getTableOf": getTableValue
    };
    const sendBody = JSON.stringify(sendInfo);
    var complete_table = "";

    if (getTableOf == "sel_room") {
        fetch("/get_room", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: sendBody
        })
        .then(response => response.json())
        .then(data => {
            complete_table = data.complete_table;
            changeColors(complete_table);
        });
    } else if (getTableOf == "sel_fac") {
        fetch("/get_fac", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: sendBody
        })
        .then(response => response.json())
        .then(data => {
            complete_table = data.complete_table;
            changeColors(complete_table);
        });
    }

    function changeColors(complete_table) {
        const shownTable = document.getElementById("time-table-shown");
        const shownRow = shownTable.getElementsByTagName("tr");

        const hiddenTable = document.getElementById("timets");
        hiddenTable.innerHTML = complete_table;
        const hiddenRow = hiddenTable.getElementsByTagName("tr");

        const cell_color = [];
        for(let i = 0; i < hiddenRow.length; i++){
          const hiddenData = hiddenRow[i].getElementsByTagName("td");
          for(let j = 0; j < hiddenData.length; j++){
            if(hiddenData[j].outerHTML.includes(getTableValue)){
              cell_color.push(hiddenData[j].classList[0]);
            }
          }
        }

        for(let i = 0; i < shownRow.length; i++){
          const shownData = shownRow[i].getElementsByTagName("td");
          for(let j = 0; j < shownData.length; j++){
            if(shownData[j].classList[0] == "lunch" || shownData[j].classList[0] == "timeslot"){
              continue;
            }
            if(cell_color.includes(shownData[j].classList[0])){
              shownData[j].style.backgroundColor = "#f0554d";
            } else {
              shownData[j].style.backgroundColor = "#81ec87";
            }
          }
        }
    }
}

  





  async function downloadPDF(){
    
    const { jsPDF } = window.jspdf;

    const canvas = await html2canvas(document.getElementById("timetsable"));
    const imgData = canvas.toDataURL('image/png');

    const pdf = new jsPDF();
    // Add the image data to the PDF
    pdf.addImage(imgData, 'PNG', 10, 10, 190, 0); // Adjust dimensions as needed

    // Save the PDF
    pdf.save("Timetable.pdf");

  }



</script>


{% endblock content %}